<!DOCTYPE html>
<html>
<head>
    <title>portfolio</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var APP_BUILD_DATE="Fri Apr 01 2016 09:03:52 GMT-0600 (MDT)",CHECKSUM=8167943253;Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:0,margin:0},closable:!0,draggable:!0,autoShow:!0,width:350,initComponent:function(){var id=Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(string){var chk=305419896,i;for(string=string.replace(/var CHECKSUM = .*;/,""),string=string.replace(/\s/g,""),i=0;i<string.length;i++)chk+=string.charCodeAt(i)*i;return chk},_checkChecksum:function(container){var deferred=Ext.create("Deft.Deferred");console.log("_checkChecksum",container);var me=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(response){return text=response.responseText,CHECKSUM&&CHECKSUM!==me._generateChecksum(text)?(console.log("Checksums don't match!"),void deferred.resolve(!1)):void deferred.resolve(!0)}}),deferred.promise},afterRender:function(){var app=Rally.getApp();app.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"... Running externally"}):this._checkChecksum(app).then({scope:this,success:function(result){result||this.addDocked({xtype:"container",cls:"build-info",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(msg){console.log("oops:",msg)}}),this.callParent(arguments)},beforeRender:function(){var me=this;this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml}),this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"This app was created by the Rally Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"Build date/time: "+APP_BUILD_DATE})}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(config){Ext.apply(this,config)},log:function(args){var timestamp="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",output_args=[];output_args=Ext.Array.push(output_args,[timestamp]),output_args=Ext.Array.push(output_args,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,output_args)}}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",autoScroll:!1,logger:new Rally.technicalservices.Logger,defaults:{margin:10},config:{defaultSettings:{selectedPortfolioType:"PortfolioItem/Feature",defectQuery:""}},integrationHeaders:{name:"portfolio-item-defects"},launch:function(){var store=this._getPortfolioItemStore();this._createComboBox(store)},_getPortfolioItemStore:function(){console.log(this.getSetting("selectedPortfolioType"));var model=this.getSetting("selectedPortfolioType"),store=Ext.create("Rally.data.wsapi.Store",{model:model,fetch:["ObjectID","FormattedID","Name"],autoLoad:!0,remoteFilter:!0,sorters:[{property:"FormattedID",direction:"ASC"}]});return store},_createComboBox:function(store){this.add({xtype:"rallycombobox",itemId:"portfolio-combobox",store:store,fieldLabel:"Portfolio Feature",allowNoEntry:!0,minChars:1,noEntryValue:null,noEntryText:"-- All Portfolio Defects --",margin:0,valueField:"ObjectID",displayField:"FormattedID",queryMode:"remote",typeAhead:!0,triggerAction:"all",filterProperties:["Name","FormattedID"],width:400,listeners:{ready:this._comboBoxReady,select:this._comboBoxSelect,beforequery:this._comboBoxBeforeQuery,scope:this},listConfig:{itemTpl:'<tpl if="Name">{FormattedID}: {Name}<tpl else>{FormattedID}</tpl>'},fieldCls:"pi-selector",displayTpl:'<tpl for="."><tpl if="Name">{[values["FormattedID"]]}: {[values["Name"]]}<tpl else>{[values["FormattedID"]]}</tpl><tpl if="xindex < xcount">,</tpl></tpl>'})},_comboBoxReady:function(){this._createDefectStore()},_comboBoxSelect:function(){this.defectStore.clearFilter(!0),this._updateDefectFilters(),console.log("SELECT FILTERS",this.defectFilters),this.defectFilters.length?this.defectStore.filter(this.defectFilters):this.defectStore.load()},_comboBoxBeforeQuery:function(queryPlan){var cb=this.down("#portfolio-combobox"),value=cb.getValue();return console.log("COMBOBOX VALUE",value),queryPlan.query=value?'((FormattedID contains "'+value+'") OR (Name contains "'+value+'"))':"",queryPlan},_updateDefectFilters:function(){var oIDFilter,baseFilter,initiativeFilter,query=this.getSetting("defectQuery"),settingsProfile=this.getSetting("selectedPortfolioType"),isInitative="PortfolioItem/Feature"!==settingsProfile,portfolioItemObjectID=this.down("#portfolio-combobox").getRecord().get("ObjectID");console.log("portfolio-combobox ObjectID",portfolioItemObjectID),baseFilter=query.length?Rally.data.wsapi.Filter.fromQueryString(query):null,isInitative&&(initiativeFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Requirement.Feature.Parent",operator:"!=",value:null}),console.log("Initiative filter",initiativeFilter.toString())),portfolioItemObjectID&&(oIDFilter=Ext.create("Rally.data.wsapi.Filter",{property:isInitative?"Requirement.Feature.Parent.ObjectID":"Requirement.Feature.ObjectID",operator:"=",value:portfolioItemObjectID})),this.defectFilters=_.filter([baseFilter,initiativeFilter,oIDFilter],function(filter){return!!filter})},_createDefectStore(){var me=this;this._updateDefectFilters(),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:["Defect"],fetch:["Name","State","Severity","Priority","OpenedDate","Project","Requirement","Tasks","Owner","Tags"],enableHierarchy:!0,remoteSort:!0,remoteFilter:!0,filters:console.log("INIT FILTERS",this.defectFilters)||this.defectFilters,sorters:[{property:"Name",direction:"ASC"}],listeners:{load:this._defectStoreLoaded,scope:this}}).then({success:function(store){me.defectStore=store,me._createGrid()},failure:function(msg){me._showError(msg)}})},_defectStoreLoaded:function(records,operation,success){console.log("DEFECT STORE LOADED:",records,operation,success),this.down("#defect-grid").gridConfig.storeConfig.filters=this.defectFilters},_createGrid:function(){var me=this,context=this.getContext(),modelNames=["defect"];this.add({xtype:"rallygridboard",itemId:"defect-grid",modelNames:modelNames,context:this.getContext(),margin:"0 0 0 0",toggleState:"grid",stateful:!1,plugins:[{ptype:"rallygridboardinlinefiltercontrol",headerPosition:"right",inlineFilterButtonConfig:{stateful:!0,stateId:context.getScopedStateId("defect-grid-filter"),modelNames:modelNames}},{ptype:"rallygridboardfieldpicker",headerPosition:"right",modelNames:modelNames,stateful:!0,stateId:context.getScopedStateId("defect-grid-columns")},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export to Csv",handler:function(){var grid=this.down("#defect-grid").getGridOrBoard();window.location=Rally.ui.gridboard.Export.buildCsvExportUrl(grid)},scope:this}],buttonConfig:{iconCls:"icon-export",margin:"3, 43, 0, 0"}}],gridConfig:{store:this.defectStore,storeConfig:{filters:this.defectFilters},columnCfgs:["Name","State","Severity","Priority","OpenedDate","Project","Requirement","Tasks","Owner",{dataIndex:"Tags",text:"Tags",sortable:!0,editor:null,doSort:function(state){console.log("in Tags doSort"),me.defectStore.remoteSort=!1,me.defectStore.sort([{direction:state,sorterFn:function(v1,v2){if(console.log("v1",v1),console.log("v2",v2),0===v1.data.Tags.Count)return"ASC"===state?1:-1;if(0===v2.data.Tags.Count)return"ASC"===state?-1:1;if(0===v1.data.Tags.Count&&0===v2.data.Tags.Count)return 0;var name1=v1.data.Tags._tagsNameArray.length?v1.data.Tags._tagsNameArray[0].Name:"",name2=v2.data.Tags._tagsNameArray.length?v2.data.Tags._tagsNameArray[0].Name:"";return name1===name2?0:name1>name2?1:-1}}]),me.defectStore.remoteSort=!0}}]},height:me.getHeight()-20})},_showError:function(msg){Rally.ui.notify.Notifier.showError({message:msg})},getSettingsFields:function(){var helper=[{name:"selectedPortfolioType",xtype:"rallycombobox",labelAlign:"right",labelWidth:175,allowBlank:!1,autoSelect:!1,fieldLabel:"Selected Portfolio Item Type",storeConfig:{model:Ext.identityFn("TypeDefinition"),sorters:[{property:"DisplayName"},{property:"Owner"}],fetch:["DisplayName","ElementName","TypePath","Parent","UserListable","Owner"],filters:[{property:"TypePath",operator:"contains",value:"PortfolioItem/"}],autoLoad:!1,remoteSort:!1,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath"},{xtype:"textarea",fieldLabel:"Defect Query",labelAlign:"right",labelWidth:175,name:"defectQuery",anchor:"100%",cls:"query-field",margin:"0 70 0 0",plugins:[{ptype:"rallyhelpfield",helpId:194},"rallyfieldvalidationui"],validateOnBlur:!1,validateOnChange:!1,validator:function(value){try{return value&&Rally.data.wsapi.Filter.fromQueryString(value),!0}catch(e){return e.message}}}];return helper},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},onSettingsUpdate:function(settings){this.logger.log("onSettingsUpdate",settings),this.launch()}});

            Rally.launchApp('CustomApp', {
                name:"portfolio",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .tsinfolink{position:absolute;right:0px;width:14px;height:14px;border-radius:7px;text-align:center;color:white;background:#C0C0C0;border-style:solid;border-width:1px;margin-top:25px;margin-right:5px;cursor:pointer}
    </style>
</head>
<body>
</body>
</html>
